<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë‚˜ë§Œì˜ AI ì±—ë´‡ (REST API)</title>
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; background-color: #f4f4f9; display: flex; height: 100vh; margin: 0; }
    #sidebar { width: 250px; background-color: #343a40; color: white; padding: 20px; display: flex; flex-direction: column; }
    #chat-container { flex: 1; display: flex; flex-direction: column; padding: 20px; }

    /* ëª©ë¡ ìŠ¤íƒ€ì¼ */
    .conv-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #495057; display: flex; justify-content: space-between; align-items: center; }
    .conv-item:hover { background-color: #495057; }
    .conv-item.active { background-color: #007bff; }

    /* ì±„íŒ…ì°½ ìŠ¤íƒ€ì¼ */
    #messages { flex: 1; border: 1px solid #ddd; background: white; border-radius: 8px; padding: 20px; overflow-y: auto; margin-bottom: 20px; }
    .message { margin-bottom: 10px; padding: 10px; border-radius: 10px; max-width: 70%; word-wrap: break-word; }
    .message.user { background-color: #007bff; color: white; align-self: flex-end; margin-left: auto; }
    .message.assistant { background-color: #e9ecef; color: black; align-self: flex-start; }

    /* ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
    #input-area { display: flex; gap: 10px; }
    input[type="text"] { flex: 1; padding: 10px; border-radius: 5px; border: 1px solid #ccc; }
    button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background-color: #0056b3; }
    button.delete-btn { background-color: #dc3545; padding: 2px 8px; font-size: 0.8em; margin-left: 10px; border-radius: 3px; }
  </style>
</head>
<body>

<div id="sidebar">
  <h3>ğŸ’¬ ëŒ€í™”ë°© ëª©ë¡</h3>
  <div style="margin-bottom: 20px; display: flex; gap: 5px;">
    <input type="text" id="newTitle" placeholder="ìƒˆ ë°© ì œëª©" style="width: 60%;">
    <button onclick="createConversation()" style="width: 35%; padding: 5px;">+</button>
  </div>
  <div id="conversation-list">
  </div>
</div>

<div id="chat-container">
  <h2 id="room-title">ëŒ€í™”ë°©ì„ ì„ íƒí•˜ì„¸ìš”</h2>
  <div id="messages" style="display: flex; flex-direction: column;">
  </div>
  <div id="input-area" style="display: none;">
    <input type="text" id="userContent" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="handleEnter(event)">
    <button onclick="sendMessage()">ì „ì†¡</button>
  </div>
</div>

<script>
  // [ì¤‘ìš”] ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì„¤ì •í•œ ê¸°ë³¸ ê²½ë¡œ (ë³µìˆ˜í˜• í†µì¼)
  const API_BASE = "http://localhost:8081/api/conversations";
  let currentChatId = null;

  // 1. ëŒ€í™”ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (GET /api/conversations)
  async function loadConversations() {
    try {
      const res = await fetch(API_BASE);
      if (!res.ok) throw new Error("ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");

      const list = await res.json();
      const container = document.getElementById("conversation-list");
      container.innerHTML = "";

      list.forEach(conv => {
        const div = document.createElement("div");
        div.className = "conv-item";
        if(currentChatId === conv.id) div.classList.add("active");

        // ì œëª© + ì‚­ì œ ë²„íŠ¼
        div.innerHTML = `
                        <span style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${conv.title}</span> 
                        <button class="delete-btn" onclick="deleteConversation(${conv.id}, event)">x</button>
                    `;
        div.onclick = () => selectConversation(conv.id, conv.title);
        container.appendChild(div);
      });
    } catch (error) {
      console.error(error);
    }
  }

  // 2. ëŒ€í™”ë°© ì„ íƒ & ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸° (GET /api/conversations/{id}/messages)
  async function selectConversation(id, title) {
    currentChatId = id;
    document.getElementById("room-title").innerText = title;
    document.getElementById("input-area").style.display = "flex";

    // UI í™œì„±í™” í‘œì‹œ ì—…ë°ì´íŠ¸
    loadConversations();

    // ë©”ì‹œì§€ ë¡œë“œ
    try {
      const res = await fetch(`${API_BASE}/${id}/messages`);
      const messages = await res.json();
      const msgContainer = document.getElementById("messages");
      msgContainer.innerHTML = "";

      messages.forEach(msg => {
        appendMessage(msg.role, msg.content);
      });
    } catch (e) {
      console.error("ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨", e);
    }
  }

  // 3. í™”ë©´ì— ë©”ì‹œì§€ ì¶”ê°€ (UI)
  function appendMessage(role, content) {
    const container = document.getElementById("messages");
    const div = document.createElement("div");
    div.className = `message ${role}`;
    div.innerText = content;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
  }

  // 4. ëŒ€í™”ë°© ìƒì„± (POST /api/conversations)
  async function createConversation() {
    const title = document.getElementById("newTitle").value;
    if(!title) return alert("ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”!");

    const encodedTitle = encodeURIComponent(title);

    try {
      // userId=1 ê³ ì • (DBì— ìœ ì €ê°€ ìˆì–´ì•¼ í•¨)
      const res = await fetch(`${API_BASE}?userId=1&title=${encodedTitle}`, { method: "POST" });

      if (res.ok) {
        const newConversationId = await res.json();
        document.getElementById("newTitle").value = "";

        // ëª©ë¡ ê°±ì‹  ë° ë°”ë¡œ ì…ì¥
        await loadConversations();
        selectConversation(newConversationId, title);
      } else {
        alert("ìƒì„± ì‹¤íŒ¨! (ì„œë²„ ë¡œê·¸ í™•ì¸ í•„ìš” - ìœ ì €ê°€ DBì— ìˆë‚˜ìš”?)");
      }
    } catch (error) {
      alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨!");
    }
  }

  // 5. ë©”ì‹œì§€ ì „ì†¡ (POST /api/conversations/{id}/messages)
  async function sendMessage() {
    const input = document.getElementById("userContent");
    const content = input.value;
    if(!content) return;

    appendMessage("user", content);
    input.value = "";

    try {
      const res = await fetch(`${API_BASE}/${currentChatId}/messages`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ content: content })
      });

      if(res.ok) {
        const data = await res.json();
        appendMessage("assistant", data.content); // data.data.contentê°€ ì•„ë‹ˆë¼ data.content (ResponseDto êµ¬ì¡° í™•ì¸)
      } else {
        appendMessage("assistant", "âš ï¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    } catch (e) {
      appendMessage("assistant", "âš ï¸ ì„œë²„ì™€ ì—°ê²°ì´ ëŠê²¼ìŠµë‹ˆë‹¤.");
    }
  }

  // 6. ëŒ€í™”ë°© ì‚­ì œ (DELETE /api/conversations/{id})
  async function deleteConversation(id, event) {
    event.stopPropagation();
    if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      await fetch(`${API_BASE}/${id}`, { method: "DELETE" });

      if(currentChatId === id) {
        document.getElementById("messages").innerHTML = "";
        document.getElementById("room-title").innerText = "ëŒ€í™”ë°©ì„ ì„ íƒí•˜ì„¸ìš”";
        document.getElementById("input-area").style.display = "none";
        currentChatId = null;
      }
      loadConversations();
    }
  }

  function handleEnter(e) {
    if(e.key === "Enter") sendMessage();
  }

  // ì‹œì‘ ì‹œ ëª©ë¡ ë¡œë“œ
  loadConversations();
</script>
</body>
</html>