<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë‚˜ë§Œì˜ AI ì±—ë´‡ (REST API)</title>
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; background-color: #f4f4f9; display: flex; height: 100vh; margin: 0; }
    #sidebar { width: 250px; background-color: #343a40; color: white; padding: 20px; display: flex; flex-direction: column; }
    #chat-container { flex: 1; display: flex; flex-direction: column; padding: 20px; }

    /* ëª©ë¡ ìŠ¤íƒ€ì¼ */
    .conv-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #495057; display: flex; justify-content: space-between; align-items: center; }
    .conv-item:hover { background-color: #495057; }
    .conv-item.active { background-color: #007bff; }

    /* ì±„íŒ…ì°½ ìŠ¤íƒ€ì¼ */
    #messages { flex: 1; border: 1px solid #ddd; background: white; border-radius: 8px; padding: 20px; overflow-y: auto; margin-bottom: 20px; }
    .message { margin-bottom: 10px; padding: 10px; border-radius: 10px; max-width: 70%; word-wrap: break-word; white-space: pre-wrap; }
    .message.user { background-color: #007bff; color: white; align-self: flex-end; margin-left: auto; }
    .message.assistant { background-color: #e9ecef; color: black; align-self: flex-start; }

    /* ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
    #input-area { display: flex; gap: 10px; }
    input[type="text"] { flex: 1; padding: 10px; border-radius: 5px; border: 1px solid #ccc; }
    button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background-color: #0056b3; }
    button.delete-btn { background-color: #dc3545; padding: 2px 8px; font-size: 0.8em; margin-left: 10px; border-radius: 3px; }
  </style>
</head>
<body>

<div id="sidebar">
  <h3>ğŸ’¬ ëŒ€í™”ë°© ëª©ë¡</h3>
  <div style="margin-bottom: 20px; display: flex; gap: 5px;">
    <input type="text" id="newTitle" placeholder="ìƒˆ ë°© ì œëª©" style="width: 60%;">
    <button onclick="createConversation()" style="width: 35%; padding: 5px;">+</button>
  </div>
  <div id="conversation-list">
  </div>
</div>

<div id="chat-container">
  <h2 id="room-title">ëŒ€í™”ë°©ì„ ì„ íƒí•˜ì„¸ìš”</h2>
  <div id="messages" style="display: flex; flex-direction: column;">
  </div>
  <div id="input-area" style="display: none;">
    <input type="text" id="userContent" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="handleEnter(event)">
    <button onclick="sendMessage()">ì „ì†¡</button>
  </div>
</div>

<script>
  const API_BASE = "http://localhost:8081/api/conversations";
  const API_KEY = "my-secret-api-key-1234"; // application.ymlê³¼ ì¼ì¹˜ì‹œí‚µë‹ˆë‹¤.
  let currentChatId = null;

  // fetch ìš”ì²­ ì‹œ ê¸°ë³¸ í—¤ë” ì…‹ì—… í—¬í¼ í•¨ìˆ˜
  function getHeaders() {
    return {
      "x-api-key": API_KEY,
      "Content-Type": "application/json"
    };
  }

  // 1. ëŒ€í™”ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
  async function loadConversations() {
    try {
      const res = await fetch(API_BASE, { headers: getHeaders() });
      if (!res.ok) throw new Error("ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");

      const list = await res.json();
      const container = document.getElementById("conversation-list");
      container.innerHTML = "";

      list.forEach(conv => {
        const div = document.createElement("div");
        div.className = "conv-item";
        if(currentChatId === conv.id) div.classList.add("active");

        div.innerHTML = `
            <span style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${conv.title}</span>
            <button class="delete-btn" onclick="deleteConversation(${conv.id}, event)">x</button>
        `;
        div.onclick = () => selectConversation(conv.id, conv.title);
        container.appendChild(div);
      });
    } catch (error) {
      console.error(error);
    }
  }

  // 2. ëŒ€í™”ë°© ì„ íƒ
  async function selectConversation(id, title) {
    currentChatId = id;
    document.getElementById("room-title").innerText = title;
    document.getElementById("input-area").style.display = "flex";

    loadConversations();

    try {
      const res = await fetch(`${API_BASE}/${id}/messages`, { headers: getHeaders() });
      const messages = await res.json();
      const msgContainer = document.getElementById("messages");
      msgContainer.innerHTML = "";

      messages.forEach(msg => {
        appendMessage(msg.role, msg.content);
      });
    } catch (e) {
      console.error("ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨", e);
    }
  }

  // 3. UI ì¶”ê°€
  function appendMessage(role, content) {
    const container = document.getElementById("messages");
    const div = document.createElement("div");
    div.className = `message ${role}`;
    div.innerText = content;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
  }

  // 4. ëŒ€í™”ë°© ìƒì„±
  async function createConversation() {
    const title = document.getElementById("newTitle").value;
    if(!title) return alert("ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”!");

    const encodedTitle = encodeURIComponent(title);

    try {
      const res = await fetch(`${API_BASE}?userId=1&title=${encodedTitle}`, {
        method: "POST",
        headers: getHeaders()
      });

      if (res.ok) {
        const newConversationId = await res.json();
        document.getElementById("newTitle").value = "";
        await loadConversations();
        selectConversation(newConversationId, title);
      } else {
        alert("ìƒì„± ì‹¤íŒ¨!");
      }
    } catch (error) {
      alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨!");
    }
  }

  // 5. ë©”ì‹œì§€ ì „ì†¡ (ëŒ€í™”ë°© ê¸°ë°˜ SSE ìŠ¤íŠ¸ë¦¬ë° ë°©ì‹ ì ìš©)
  function sendMessage() {
    if (!currentChatId) {
      alert("ëŒ€í™”ë°©ì„ ë¨¼ì € ìƒì„±í•˜ê±°ë‚˜ ì„ íƒí•´ì£¼ì„¸ìš”.");
      return;
    }

    const input = document.getElementById("userContent");
    const content = input.value;
    if(!content) return;

    // ë‚´ ë©”ì‹œì§€ í™”ë©´ì— í‘œì‹œ
    appendMessage("user", content);
    input.value = "";

    // AI ë©”ì‹œì§€ ê·¸ë¦‡(ë§í’ì„ ) ë¯¸ë¦¬ ë§Œë“¤ê¸° (ë¹ˆ ë‚´ìš©ìœ¼ë¡œ)
    const aiMessageDiv = document.createElement("div");
    aiMessageDiv.className = "message assistant";
    document.getElementById("messages").appendChild(aiMessageDiv);

    // SSE ì—°ê²° ì‹œì‘ (GET ë°©ì‹) - EventSourceëŠ” ì»¤ìŠ¤í…€ í—¤ë”ë¥¼ ë³´ë‚¼ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ apiKey ì „ë‹¬
    const eventSource = new EventSource(`${API_BASE}/${currentChatId}/stream?message=${encodeURIComponent(content)}&apiKey=${API_KEY}`);

    eventSource.onmessage = function(event) {
      const rawData = event.data;

      // "[DONE]" ì´ ì˜¤ë©´ ì¢…ë£Œ (OpenAI í‘œì¤€)
      if (rawData === "[DONE]") {
        eventSource.close();
        return;
      }

      try {
        // OpenAI ì‘ë‹µ íŒŒì‹±
        const json = JSON.parse(rawData);
        // choicesê°€ ìˆê³  delta.contentê°€ ìˆëŠ”ì§€ í™•ì¸
        if (json.choices && json.choices.length > 0) {
          const contentChunk = json.choices[0].delta.content;
          if (contentChunk) {
            // ê¸€ìë¥¼ ê¸°ì¡´ ë§í’ì„ ì— ê³„ì† ì´ì–´ ë¶™ì„
            aiMessageDiv.innerText += contentChunk;

            // ìŠ¤í¬ë¡¤ ì•„ë˜ë¡œ ì´ë™
            const container = document.getElementById("messages");
            container.scrollTop = container.scrollHeight;
          }
        }
      } catch (e) {
        // JSON íŒŒì‹± ì—ëŸ¬ë‚˜ ì¤‘ê°„ ë°ì´í„°ëŠ” ë¬´ì‹œ
      }
    };

    eventSource.onerror = function() {
      eventSource.close(); // ì—ëŸ¬ ì‹œ ì—°ê²° ì¢…ë£Œ
    };
  }

  // 6. ì‚­ì œ
  async function deleteConversation(id, event) {
    event.stopPropagation();
    if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      await fetch(`${API_BASE}/${id}`, {
        method: "DELETE",
        headers: getHeaders()
      });

      if(currentChatId === id) {
        document.getElementById("messages").innerHTML = "";
        document.getElementById("room-title").innerText = "ëŒ€í™”ë°©ì„ ì„ íƒí•˜ì„¸ìš”";
        document.getElementById("input-area").style.display = "none";
        currentChatId = null;
      }
      loadConversations();
    }
  }

  function handleEnter(e) {
    if(e.key === "Enter") sendMessage();
  }

  loadConversations();
</script>
</body>
</html>